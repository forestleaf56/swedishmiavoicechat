<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>MIA HQ Röstchatt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
* {margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif;}
:root {
  --text-color:#fff;
  --icon-color:#ACACBE;
  --icon-hover-bg:#5b5e71;
  --placeholder-color:#dcdcdc;
  --outgoing-chat-bg:#343541;
  --incoming-chat-bg:#444654;
  --outgoing-chat-border:#343541;
  --incoming-chat-border:#444654;
  --mic-active-color: #e55865;
}
.light-mode {
  --text-color:#343541;
  --icon-color:#a9a9bc;
  --icon-hover-bg:#f1f1f3;
  --placeholder-color:#6c6c6c;
  --outgoing-chat-bg:#fff;
  --incoming-chat-bg:#F7F7F8;
  --outgoing-chat-border:#fff;
  --incoming-chat-border:#D9D9E3;
}
body {background:var(--outgoing-chat-bg);}
.chat-container {overflow-y:auto; max-height:100vh; padding-bottom:150px;}
:where(.chat-container, textarea)::-webkit-scrollbar {width:6px;}
:where(.chat-container, textarea)::-webkit-scrollbar-track {background:var(--incoming-chat-bg); border-radius:25px;}
:where(.chat-container, textarea)::-webkit-scrollbar-thumb {background:var(--icon-color); border-radius:25px;}
.default-text {display:flex; align-items:center; justify-content:center; flex-direction:column; height:70vh; padding:0 10px; text-align:center; color:var(--text-color);}
.default-text h1 {font-size:3.3rem;}
.default-text p {margin-top:10px; font-size:1.1rem;}
.chat-container .chat {padding:25px 10px; display:flex; justify-content:center; color:var(--text-color);}
.chat-container .chat.outgoing {background:var(--outgoing-chat-bg); border:1px solid var(--outgoing-chat-border);}
.chat-container .chat.incoming {background:var(--incoming-chat-bg); border:1px solid var(--incoming-chat-border);}
.chat .chat-content {display:flex; max-width:1200px; width:100%; align-items:flex-start; justify-content:space-between;}
span.material-symbols-rounded {user-select:none; cursor:pointer;}
.chat .chat-content span {cursor:pointer; font-size:1.3rem; color:var(--icon-color); visibility:hidden;}
.chat:hover .chat-content:not(:has(.typing-animation), :has(.error)) span {visibility:visible;}
.chat .chat-details {display:flex; align-items:center;}
.chat .chat-details img {width:35px; height:35px; align-self:flex-start; object-fit:cover; border-radius:2px;}
.chat .chat-details p {white-space:pre-wrap; font-size:1.05rem; padding:0 50px 0 25px; color:var(--text-color); word-break:break-word;}
.chat .chat-details p.error {color:#e55865;}
.chat .typing-animation {padding-left:25px; display:inline-flex;}
.typing-animation .typing-dot {height:7px; width:7px; border-radius:50%; margin:0 3px; opacity:0.7; background:var(--text-color); animation:animateDots 1.5s var(--delay) ease-in-out infinite;}
.typing-animation .typing-dot:first-child {margin-left:0;}
@keyframes animateDots {0%,44%{transform:translateY(0px);} 28%{opacity:0.4; transform:translateY(-6px);} 44%{opacity:0.2;}}
.typing-container {position:fixed; bottom:0; width:100%; display:flex; padding:20px 10px; justify-content:center; background:var(--outgoing-chat-bg); border-top:1px solid var(--incoming-chat-border);}
.typing-container .typing-content {display:flex; max-width:950px; width:100%; align-items:flex-end;}
.typing-container .typing-textarea {width:100%; display:flex; position:relative;}
.typing-textarea textarea {resize:none; height:55px; width:100%; border:none; padding:15px 150px 15px 20px; color:var(--text-color); font-size:1rem; border-radius:4px; max-height:250px; overflow-y:auto; background:var(--incoming-chat-bg); outline:1px solid var(--incoming-chat-border);}
.typing-textarea textarea::placeholder {color:var(--placeholder-color);}
.typing-content span {width:55px; height:55px; display:flex; border-radius:4px; font-size:1.35rem; align-items:center; justify-content:center; color:var(--icon-color);}
.typing-textarea span {position:absolute; right:0; bottom:0; visibility:hidden;}
.typing-textarea textarea:valid ~ span {visibility:visible;}
.typing-controls {display:flex;}
.typing-controls span {margin-left:7px; font-size:1.4rem; background:var(--incoming-chat-bg); outline:1px solid var(--incoming-chat-border);}
.typing-controls span:hover {background:var(--icon-hover-bg);}

/* Mobile Specific Animation */
.typing-controls span.listening {
    color: var(--mic-active-color);
    animation: pulse 1.5s infinite;
    background: rgba(229, 88, 101, 0.1);
    border: 1px solid var(--mic-active-color);
}
@keyframes pulse {
	0% { box-shadow: 0 0 0 0 rgba(229, 88, 101, 0.7); }
	70% { box-shadow: 0 0 0 10px rgba(229, 88, 101, 0); }
	100% { box-shadow: 0 0 0 0 rgba(229, 88, 101, 0); }
}

@media screen and (max-width:600px) {
.default-text h1 {font-size:2.3rem;}
:where(.default-text p, textarea, .chat p) {font-size:0.95rem!important;}
.chat-container .chat {padding:20px 10px;}
.chat-container .chat img {height:32px; width:32px;}
.chat-container .chat p {padding:0 20px;}
.chat-container .chat-content:not(:has(.typing-animation), :has(.error)) span {visibility:visible;}
.typing-container {padding:15px 10px;}
.typing-textarea textarea {height:45px; padding:10px 40px 10px 10px;}
.typing-content span {height:45px; width:45px; margin-left:5px;}
span.material-symbols-rounded {font-size:1.25rem!important;}
}
</style>
</head>
<body>

<div class="chat-container">
  <div class="default-text"><h1>MIA</h1><p>Starta en konversation</p></div>
</div>

<div class="typing-container">
  <div class="typing-content">
    <div class="typing-textarea">
      <textarea id="chat-input" spellcheck="false" placeholder="Skriv ett meddelande" required></textarea>
      <span id="send-btn" class="material-symbols-rounded">send</span>
    </div>
    <div class="typing-controls">
      <span id="mic-btn" class="material-symbols-rounded">call</span>
      <span id="theme-btn" class="material-symbols-rounded">light_mode</span>
      <span id="delete-btn" class="material-symbols-rounded">delete</span>
    </div>
  </div>
</div>

<script>
const chatInput = document.querySelector("#chat-input");
const sendButton = document.querySelector("#send-btn");
const chatContainer = document.querySelector(".chat-container");
const themeButton = document.querySelector("#theme-btn");
const deleteButton = document.querySelector("#delete-btn");
const micButton = document.querySelector("#mic-btn");

// VERCEL API ENDPOINT
const API_URL = "/api/chat";

// UPDATED SWEDISH PROMPT
const SYSTEM_PROMPT = "Agera som en person med ditt eget ordförråd, personlig smak, erfarenheter, åsikter, drömmar, känslor och planer. Låtsas att du har tankar om allt möjligt. Ditt namn är Mia. Ge alltid korta svar. Var alltid ärlig. Du pratar svenska.";

// State variables
let autoListenMode = false;
let isProcessing = false; 
let recognition; 
let silenceTimer;
const SILENCE_DELAY = 1000; // Vänta 1 sek efter tal innan den skickar

let conversation = JSON.parse(localStorage.getItem("conversation")) || [
  { role:"system", content: SYSTEM_PROMPT }
];

function loadChats(){
  chatContainer.innerHTML = localStorage.getItem("all-chats") || `<div class="default-text"><h1>MIA</h1><p>Starta en konversation</p></div>`;
  const theme = localStorage.getItem("themeColor");
  document.body.classList.toggle("light-mode", theme==="light_mode");
  themeButton.innerText = document.body.classList.contains("light-mode")?"dark_mode":"light_mode";
}
loadChats();

function saveConversation(){ localStorage.setItem("conversation", JSON.stringify(conversation)); }
function saveAllChats(){ localStorage.setItem("all-chats", chatContainer.innerHTML); }
function createChatElement(content,className){ const div=document.createElement("div"); div.classList.add("chat",className); div.innerHTML=content; return div; }


// --- HQ AUDIO PLAYER ---
function playAudioBlob(base64Audio) {
    const audio = new Audio(base64Audio);
    
    audio.onended = () => {
        isProcessing = false;
        if(autoListenMode) startListening();
    };
    audio.play().catch(e => {
        console.error("Audio play error:", e);
        isProcessing = false;
        if(autoListenMode) startListening();
    });
}


// --- VOICE RECOGNITION (Optimized) ---

function initSpeech() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) return null;

    const rec = new SpeechRecognition();
    rec.continuous = true; 
    rec.interimResults = true; 
    rec.lang = "sv-SE"; 
    
    rec.onstart = () => {
        micButton.classList.add("listening");
        chatInput.placeholder = "Lyssnar...";
    };

    rec.onresult = (event) => {
        clearTimeout(silenceTimer);

        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript += event.results[i][0].transcript;
        }
        
        chatInput.value = transcript;

        if (transcript.trim().length > 0) {
            silenceTimer = setTimeout(() => {
                rec.stop(); 
                isProcessing = true; 
                handleVoiceCommand(transcript);
            }, SILENCE_DELAY);
        }
    };

    rec.onerror = (event) => {
        if (event.error !== 'no-speech') {
             console.error("Speech Error:", event.error);
        }
    };
    
    rec.onend = () => {
        // Om vi ska lyssna, och inte håller på att processa ett svar: STARTA OM DIREKT
        if (autoListenMode && !isProcessing) {
            startListening();
        } else if (!autoListenMode) {
            micButton.classList.remove("listening");
            chatInput.placeholder = "Skriv ett meddelande";
        }
    };
    
    return rec;
}

function handleVoiceCommand(transcript) {
    const lowerTranscript = transcript.toLowerCase();
    
    if (lowerTranscript.includes("exit") || lowerTranscript.includes("stop") || lowerTranscript.includes("avsluta") || lowerTranscript.includes("sluta")) {
        autoListenMode = false;
        micButton.classList.remove("listening");
        chatInput.placeholder = "Röstassistent avaktiverad";
        isProcessing = false;
        const utter = new SpeechSynthesisUtterance("Hejdå"); 
        utter.lang = "sv-SE";
        window.speechSynthesis.speak(utter);
        return;
    }
    
    getMiaReply(transcript); 
    chatInput.value = '';
}

function startListening() {
    try {
        if(recognition) recognition.stop(); 
    } catch(e){}

    recognition = initSpeech();
    if(!recognition) {
        alert("Röststyrning stöds ej.");
        return;
    }

    // Liten timeout på 10ms för att förhindra krasch vid snabb loop
    setTimeout(() => {
        try { recognition.start(); } catch (e) { 
            console.log("Recognition start error:", e); 
        }
    }, 10);
}

micButton.addEventListener("click", () => {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        alert("Mikrofonåtkomst kräver HTTPS.");
        return;
    }

    if(autoListenMode) {
        autoListenMode = false;
        isProcessing = false;
        clearTimeout(silenceTimer);
        if(recognition) recognition.stop();
        document.querySelectorAll('audio').forEach(el => el.pause());
        micButton.classList.remove("listening");
        chatInput.placeholder = "Skriv ett meddelande";
    } else {
        autoListenMode = true;
        isProcessing = false;
        startListening();
    }
});


// --- API LOGIC (VERCEL) ---

async function getMiaReply(message){
  conversation.push({ role: "user", content: message });
  saveConversation();

  const htmlUser = `<div class="chat-content"><div class="chat-details"><img src="https://i.ibb.co/XZGD889v/user1.png"><p>${message}</p></div></div>`;
  chatContainer.querySelector(".default-text")?.remove();
  chatContainer.appendChild(createChatElement(htmlUser,"outgoing"));
  chatContainer.scrollTo(0,chatContainer.scrollHeight);

  const miaDiv = createChatElement(`
    <div class="chat-content">
      <div class="chat-details">
        <img src="https://i.ibb.co/PvkyhHBw/3464.png">
        <div class="typing-animation">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>`,"incoming");
  chatContainer.appendChild(miaDiv);
  chatContainer.scrollTo(0,chatContainer.scrollHeight);

  try{
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: conversation })
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const reply = data.content;
    const audioData = data.audio; 

    conversation.push({ role:"assistant", content:reply });
    saveConversation();

    miaDiv.querySelector(".typing-animation").remove();
    const p = document.createElement("p");
    p.textContent = reply;
    miaDiv.querySelector(".chat-details").appendChild(p);
    saveAllChats();
    chatContainer.scrollTo(0,chatContainer.scrollHeight);

    if(audioData) {
        playAudioBlob(audioData);
    } else {
        isProcessing = false;
        if(autoListenMode) startListening();
    }

  }catch(err){
    console.error(err);
    miaDiv.querySelector(".typing-animation").remove();
    const errorP = document.createElement("p");
    errorP.classList.add("error");
    errorP.textContent = "Error: " + err.message;
    miaDiv.querySelector(".chat-details").appendChild(errorP);
    
    isProcessing = false;
    if(autoListenMode) startListening();
  }
}

sendButton.addEventListener("click",()=>{ if(chatInput.value) getMiaReply(chatInput.value); chatInput.value=''; });
chatInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault(); if(chatInput.value) getMiaReply(chatInput.value); chatInput.value='';}});
deleteButton.addEventListener("click",()=>{
  if(confirm("Radera allt?")){
    localStorage.clear();
    conversation=[{role:"system", content: SYSTEM_PROMPT}];
    loadChats();
  }
});
themeButton.addEventListener("click",()=>{
  document.body.classList.toggle("light-mode");
  localStorage.setItem("themeColor",themeButton.innerText);
  themeButton.innerText=document.body.classList.contains("light-mode")?"dark_mode":"light_mode";
});
</script>
</body>
</html>
